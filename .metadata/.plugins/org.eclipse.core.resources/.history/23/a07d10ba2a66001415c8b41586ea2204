// AVF-1411 - Project 1a
// Fred L. Strout
// Created on: 10/30/2014

var saveData = require("db");

// Wrap the whole package in a function for stronger execution control
var netCheck = function(url){ // pass in the url from the function call for improved modularization
	
	// Create a variable to pass to the onload property of the createHTTPClient method
	var loadData = function (e){
		var remoteData = JSON.parse(this.responseText);
		var observe = remoteData.current_observation;
		var forecast = remoteData.forecast.simpleforecast.forecastday[0];
		console.log(remoteData);
		
		var icon = observe.icon;
		var location = observe.display_location.full;
		var feels = observe.feelslike_f;
		var last = observe.observation_time;
		var condition = observe.weather;
		var min = forecast.low.fahrenheit;
		var max = forecast.high.fahrenheit;
		var fahrenheit = observe.temp_f;
		var celsius = observe.temp_c;
		var humidity = observe.relative_humidity;
		var precip = observe.precip_today_in;
		var heat = observe.heat_index_f;
		var press = observe.pressure_in;
		var windSpeed = observe.wind_mph;
		var windDirection = observe.wind_dir;
		var windDegrees = observe.wind_degrees;
		var hour = observe.observation_time_rfc822.substring(17, 19);
		console.log("Hour = " + hour);
		
		if (icon === "clear" || icon === "sunny"){
			var ico = "/icons/Sun.gif";
		} else if (icon === "chancerain" || icon === "rain"){
			var ico = "/icons/Rain.gif";
		} else if (icon === "tstorms" || icon === "unknown"){
			var ico = "/icons/Lightning.gif";
		} else if (icon === "cloudy"){
			var ico = "/icons/Overcast.gif";
		} else if (icon === "mostlycloudy"){
			var ico = "/icons/PartlyCloudy.gif";
		};
		
		saveData.create(ico, location, feels, last, condition, min, max, fahrenheit, celsius, humidity, precip, heat, press, windSpeed, windDirection, windDegrees);
	};
	
	// Create an alert box to display an error message for the onerror property of the createHTTPClient method
	var errorData = function (e){
		alert("Error: " + e.error);
	};
	
	// If statement to detect if the device is connected to the Network
	if (Ti.Network.online){ // If True, then
		var db = Ti.Database.open ('localData');
		db.execute('DELETE FROM tblData');
		db.close();
		
		var remoteData = Ti.Network.createHTTPClient({
			onload: loadData,
			onerror: errorData
		});
		remoteData.open("GET", url);
		remoteData.send();
		
	}else{ // If False, then
		alert("Network unavailable. Check your settings.");
	};
};

exports.checkNet = netCheck;